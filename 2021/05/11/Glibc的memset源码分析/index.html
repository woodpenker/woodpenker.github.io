<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"woodpenker.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":true,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="分析了glibc的memset源码实现,以及相关的CPU的ERMS&#x2F;AVX2(512)特性学习.">
<meta property="og:type" content="article">
<meta property="og:title" content="Glibc的memset源码分析">
<meta property="og:url" content="https://woodpenker.github.io/2021/05/11/Glibc%E7%9A%84memset%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="woodpenker&#39;s blog">
<meta property="og:description" content="分析了glibc的memset源码实现,以及相关的CPU的ERMS&#x2F;AVX2(512)特性学习.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-05-11T13:40:14.000Z">
<meta property="article:modified_time" content="2021-05-11T14:02:33.774Z">
<meta property="article:author" content="woodpenker">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://woodpenker.github.io/2021/05/11/Glibc%E7%9A%84memset%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Glibc的memset源码分析 | woodpenker's blog</title>
  
    <script>
      function sendPageView() {
        if (CONFIG.hostname !== location.hostname) return;
        var uid = localStorage.getItem('uid') || (Math.random() + '.' + Math.random());
        localStorage.setItem('uid', uid);
        navigator.sendBeacon('https://www.google-analytics.com/collect', new URLSearchParams({
          v  : 1,
          tid: 'UA-156045206-1',
          cid: uid,
          t  : 'pageview',
          dp : encodeURIComponent(location.pathname)
        }));
      }
      document.addEventListener('pjax:complete', sendPageView);
      sendPageView();
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">woodpenker's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">while(life!=0){study++;}</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/woodpenker" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://woodpenker.github.io/2021/05/11/Glibc%E7%9A%84memset%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="woodpenker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="woodpenker's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Glibc的memset源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-05-11 21:40:14 / Modified: 22:02:33" itemprop="dateCreated datePublished" datetime="2021-05-11T21:40:14+08:00">2021-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          
            <span id="/2021/05/11/Glibc%E7%9A%84memset%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-meta-item leancloud_visitors" data-flag-title="Glibc的memset源码分析" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/05/11/Glibc%E7%9A%84memset%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/05/11/Glibc%E7%9A%84memset%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>8.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>8 mins.</span>
            </span>
            <div class="post-description">分析了glibc的memset源码实现,以及相关的CPU的ERMS/AVX2(512)特性学习.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Glibc的memset源码分析"><a href="#Glibc的memset源码分析" class="headerlink" title="Glibc的memset源码分析"></a>Glibc的memset源码分析</h1><h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><p>CPU配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">model name      : Intel(R) Xeon(R) Gold 6134 CPU @ 3.20GHz</span><br><span class="line"></span><br><span class="line">flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc art arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cpuid_fault epb cat_l3 cdp_l3 invpcid_single pti intel_ppin ssbd mba ibrs ibpb stibp tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm mpx rdt_a avx512f avx512dq rdseed adx smap clflushopt clwb intel_pt avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 xsaves cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local dtherm arat pln pts hwp hwp_act_window hwp_epp hwp_pkg_req pku ospke md_clear flush_l1d</span><br></pre></td></tr></table></figure>

<p>可以发现其中支持avx的flag: <code>avx2</code>,<code>avx512f</code>… 以及ERMS(<code>erms</code>)的支持.</p>
<p>使用的<code>glibc</code>库是<code>libc-2.27.so</code>.</p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>查看<code>glibc-2.27</code>的版本代码,在<code>sysdeps/x86_64/multiarch/</code>目录下, 在文件<code>ifunc-memset.h</code>中定义了是否使用<code>erms</code>和<code>avx512</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (CPU_FEATURES_ARCH_P (cpu_features, Prefer_ERMS))</span><br><span class="line">   <span class="keyword">return</span> OPTIMIZE (erms);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (CPU_FEATURES_ARCH_P (cpu_features, AVX512F_Usable)</span><br><span class="line">     &amp;&amp; !CPU_FEATURES_ARCH_P (cpu_features, Prefer_No_AVX512))</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> (CPU_FEATURES_ARCH_P (cpu_features, Prefer_No_VZEROUPPER))</span><br><span class="line"><span class="keyword">return</span> OPTIMIZE (avx512_no_vzeroupper);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (CPU_FEATURES_CPU_P (cpu_features, ERMS))</span><br><span class="line"><span class="keyword">return</span> OPTIMIZE (avx512_unaligned_erms);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> OPTIMIZE (avx512_unaligned);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (CPU_FEATURES_ARCH_P (cpu_features, AVX2_Usable))</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> (CPU_FEATURES_CPU_P (cpu_features, ERMS))</span><br><span class="line"><span class="keyword">return</span> OPTIMIZE (avx2_unaligned_erms);</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> OPTIMIZE (avx2_unaligned);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>无论<code>avx2</code>还是<code>avx512</code>都共享使用了<code>sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S</code>中的代码,其中大致逻辑是如果支持erms就使用erms相关代码, 并针对对齐和非对齐的情况进行处理, 只有在<code>erms</code>支持的条件下才会执行到<code>L(stosb)</code>处的代码. 而非<code>erms</code>支持的的则执行<code>L(more_2x_vec):</code>进入循环执行mov操作, <code>VMOVU(A)</code>在<code>avx2</code>和<code>avx512</code>下分别是<code>vmovdqu(a)</code>和<code>vmovdqu(a)64</code></p>
<p><code>VEC_SIZE</code>在<code>avx512</code>下是64,在<code>avx2</code>下是32.</p>
<p>相关代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* memset is implemented as:</span><br><span class="line">   1. Use overlapping store to avoid branch.</span><br><span class="line">   2. If size is less than VEC, use integer register stores.</span><br><span class="line">   3. If size is from VEC_SIZE to 2 * VEC_SIZE, use 2 VEC stores.</span><br><span class="line">   4. If size is from 2 * VEC_SIZE to 4 * VEC_SIZE, use 4 VEC stores.</span><br><span class="line">   5. If size is more to 4 * VEC_SIZE, align to 4 * VEC_SIZE with</span><br><span class="line">      4 VEC stores and store 4 * VEC at a time until done.  *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; stosb的相关代码在这里: </span><br><span class="line">L(stosb):</span><br><span class="line">	&#x2F;* Issue vzeroupper before rep stosb.  *&#x2F;</span><br><span class="line">	VZEROUPPER</span><br><span class="line">	movq	%rdx, %rcx</span><br><span class="line">	movzbl	%sil, %eax</span><br><span class="line">	movq	%rdi, %rdx</span><br><span class="line">	rep stosb</span><br><span class="line">	movq	%rdx, %rax</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 触发进入stosb的条件是:rdx值大于REP_STOSB_THRESHOLD, 且满足大于2*VEC_SIZE</span><br><span class="line">ENTRY (MEMSET_SYMBOL (__memset, unaligned_erms))</span><br><span class="line">	MEMSET_VDUP_TO_VEC0_AND_SET_RETURN (%esi, %rdi)</span><br><span class="line">	cmpq	$VEC_SIZE, %rdx</span><br><span class="line">	jb	L(less_vec)</span><br><span class="line">	cmpq	$(VEC_SIZE * 2), %rdx</span><br><span class="line">	ja	L(stosb_more_2x_vec)</span><br><span class="line">	&#x2F;* From VEC and to 2 * VEC.  No branch when size &#x3D;&#x3D; VEC_SIZE.  *&#x2F;</span><br><span class="line">	VMOVU	%VEC(0), -VEC_SIZE(%rdi,%rdx)</span><br><span class="line">	VMOVU	%VEC(0), (%rdi)</span><br><span class="line">	VZEROUPPER</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">L(stosb_more_2x_vec):</span><br><span class="line">	cmpq	$REP_STOSB_THRESHOLD, %rdx</span><br><span class="line">	ja	L(stosb)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#x2F;* Threshold to use Enhanced REP STOSB.  Since there is overhead to set</span><br><span class="line">   up REP STOSB operation, REP STOSB isn&#39;t faster on short data.  The</span><br><span class="line">   memset micro benchmark in glibc shows that 2KB is the approximate</span><br><span class="line">   value above which REP STOSB becomes faster on processors with</span><br><span class="line">   Enhanced REP STOSB.  Since the stored value is fixed, larger register</span><br><span class="line">   size has minimal impact on threshold.  *&#x2F;</span><br><span class="line">#ifndef REP_STOSB_THRESHOLD</span><br><span class="line"># define REP_STOSB_THRESHOLD		2048</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">L(more_2x_vec):</span><br><span class="line">	cmpq  $(VEC_SIZE * 4), %rdx</span><br><span class="line">	ja	L(loop_start)</span><br><span class="line">	VMOVU	%VEC(0), (%rdi)</span><br><span class="line">	VMOVU	%VEC(0), VEC_SIZE(%rdi)</span><br><span class="line">	VMOVU	%VEC(0), -VEC_SIZE(%rdi,%rdx)</span><br><span class="line">	VMOVU	%VEC(0), -(VEC_SIZE * 2)(%rdi,%rdx)</span><br><span class="line">L(return):</span><br><span class="line">	VZEROUPPER</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">L(loop_start):</span><br><span class="line">	leaq	(VEC_SIZE * 4)(%rdi), %rcx</span><br><span class="line">	VMOVU	%VEC(0), (%rdi)</span><br><span class="line">	andq	$-(VEC_SIZE * 4), %rcx</span><br><span class="line">	VMOVU	%VEC(0), -VEC_SIZE(%rdi,%rdx)</span><br><span class="line">	VMOVU	%VEC(0), VEC_SIZE(%rdi)</span><br><span class="line">	VMOVU	%VEC(0), -(VEC_SIZE * 2)(%rdi,%rdx)</span><br><span class="line">	VMOVU	%VEC(0), (VEC_SIZE * 2)(%rdi)</span><br><span class="line">	VMOVU	%VEC(0), -(VEC_SIZE * 3)(%rdi,%rdx)</span><br><span class="line">	VMOVU	%VEC(0), (VEC_SIZE * 3)(%rdi)</span><br><span class="line">	VMOVU	%VEC(0), -(VEC_SIZE * 4)(%rdi,%rdx)</span><br><span class="line">	addq	%rdi, %rdx</span><br><span class="line">	andq	$-(VEC_SIZE * 4), %rdx</span><br><span class="line">	cmpq	%rdx, %rcx</span><br><span class="line">	je	L(return)</span><br><span class="line">L(loop):</span><br><span class="line">	VMOVA	%VEC(0), (%rcx)</span><br><span class="line">	VMOVA	%VEC(0), VEC_SIZE(%rcx)</span><br><span class="line">	VMOVA	%VEC(0), (VEC_SIZE * 2)(%rcx)</span><br><span class="line">	VMOVA	%VEC(0), (VEC_SIZE * 3)(%rcx)</span><br><span class="line">	addq	$(VEC_SIZE * 4), %rcx</span><br><span class="line">	cmpq	%rcx, %rdx</span><br><span class="line">	jne	L(loop)</span><br><span class="line">	VZEROUPPER_SHORT_RETURN</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<h3 id="glibc代码逻辑验证"><a href="#glibc代码逻辑验证" class="headerlink" title="glibc代码逻辑验证"></a>glibc代码逻辑验证</h3><p>测试验证以上逻辑:</p>
<p>当<code>rdx&gt;2048</code>时:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">5000</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(str, <span class="string">'a'</span>, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>perf top</code>查看是<code>L(stosb)</code>处的代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    │    000000000018ef20 &lt;__nss_group_lookup@GLIBC_2.2.5+0x251e0&gt;:</span><br><span class="line"> 0.91 │      vzeroupper</span><br><span class="line">      │      mov    %rdx,%rcx</span><br><span class="line">      │      movzbl %sil,%eax</span><br><span class="line">      │      mov    %rdi,%rdx</span><br><span class="line">98.32 │      rep    stos %al,%es:(%rdi)</span><br><span class="line"> 0.76 │      mov    %rdx,%rax</span><br><span class="line">      │    ← retq</span><br></pre></td></tr></table></figure>
<p>当<code>rdx&lt;=2048</code>时:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">5000</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(str, <span class="string">'a'</span>, <span class="number">2048</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>perf top</code>查看是<code>L(loop)</code>处的代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__memset_avx2_unaligned_erms  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so</span><br><span class="line">Percent│       vmovdqu %ymm0,(%rdi)</span><br><span class="line">       │       and    $0xffffffffffffff80,%rcx</span><br><span class="line">  6.41 │       vmovdqu %ymm0,-0x20(%rdi,%rdx,1)</span><br><span class="line">       │       vmovdqu %ymm0,0x20(%rdi)</span><br><span class="line">       │       vmovdqu %ymm0,-0x40(%rdi,%rdx,1)</span><br><span class="line">       │       vmovdqu %ymm0,0x40(%rdi)</span><br><span class="line">  3.71 │       vmovdqu %ymm0,-0x60(%rdi,%rdx,1)</span><br><span class="line">       │       vmovdqu %ymm0,0x60(%rdi)</span><br><span class="line">       │       vmovdqu %ymm0,-0x80(%rdi,%rdx,1)</span><br><span class="line">       │       add    %rdi,%rdx</span><br><span class="line">  3.61 │       and    $0xffffffffffffff80,%rdx</span><br><span class="line">       │       cmp    %rdx,%rcx</span><br><span class="line">       │     ↑ je     51</span><br><span class="line"> 14.78 │ 97:   vmovdqa %ymm0,(%rcx)</span><br><span class="line"> 37.20 │       vmovdqa %ymm0,0x20(%rcx)</span><br><span class="line"> 13.57 │       vmovdqa %ymm0,0x40(%rcx)</span><br><span class="line"> 13.06 │       vmovdqa %ymm0,0x60(%rcx)</span><br><span class="line">  3.45 │       add    $0x80,%rcx</span><br><span class="line">       │       cmp    %rcx,%rdx</span><br><span class="line">       │     ↑ jne    97</span><br><span class="line">  0.94 │       vzeroupper</span><br><span class="line">       │     ← retq</span><br><span class="line">       │ ba:   cmp    $0x10,%dl</span><br><span class="line">       │     ↓ jae    db</span><br><span class="line">       │       vmovq  %xmm0,%rcx</span><br><span class="line">       │       cmp    $0x8,%dl</span><br><span class="line">       │     ↓ jae    e9</span><br></pre></td></tr></table></figure>

<p>当<code>rdx&lt;128</code>时:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">5000</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(str, <span class="string">'a'</span>, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>perf top</code>查看是<code>L(more_2x_vec)</code>处的代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__memset_avx2_unaligned_erms  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so</span><br><span class="line">Percent│     ↓ jb     ba</span><br><span class="line">       │       cmp    $0x40,%rdx</span><br><span class="line">       │     ↓ ja     2a</span><br><span class="line">       │       vmovdqu %ymm0,-0x20(%rdi,%rdx,1)</span><br><span class="line">       │       vmovdqu %ymm0,(%rdi)</span><br><span class="line">       │       vzeroupper</span><br><span class="line">       │     ← retq</span><br><span class="line">       │ 2a:   cmp    $0x800,%rdx</span><br><span class="line">       │     → ja     18ef20 &lt;__nss_group_lookup@GLIBC_2.2.5+0x251e0&gt;</span><br><span class="line">       │       cmp    $0x80,%rdx</span><br><span class="line">       │     ↓ ja     55</span><br><span class="line"> 24.76 │       vmovdqu %ymm0,(%rdi)</span><br><span class="line">  0.01 │       vmovdqu %ymm0,0x20(%rdi)</span><br><span class="line">       │       vmovdqu %ymm0,-0x20(%rdi,%rdx,1)</span><br><span class="line"> 61.51 │       vmovdqu %ymm0,-0x40(%rdi,%rdx,1)</span><br><span class="line">       │ 51:   vzeroupper</span><br><span class="line">       │     ← retq</span><br></pre></td></tr></table></figure>

<p>由于<code>cpu</code>均支持<code>erms</code>, 所以进入的逻辑是<code>erms</code>相关代码.</p>
<h4 id="avx指令可能导致cpu降频的问题"><a href="#avx指令可能导致cpu降频的问题" class="headerlink" title="avx指令可能导致cpu降频的问题"></a>avx指令可能导致cpu降频的问题</h4><p>根据<a href="https://bugs.launchpad.net/linux/+bug/1727136" target="_blank" rel="noopener">https://bugs.launchpad.net/linux/+bug/1727136</a> 和 <a href="https://bugs.launchpad.net/linux/+bug/1727136" target="_blank" rel="noopener">https://bugs.launchpad.net/linux/+bug/1727136</a> 中的描述, <code>glibc</code>不使用<code>avx</code>相关代码实现<code>memcpy/memset</code>是为了避免可能导致cpu降频,并引起性能力下降.</p>
<p>通过检测代码:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo perf stat -e cpu/event=0x28,umask=0x18,name=core_power_lvl1_turbo_license/,cpu/event=0x28,umask=0x20,name=core_power_lvl2_turbo_license/,cpu/event=0x28,umask=0x40,name=core_power_throttle/,cycles -a -I 1000 sleep 10</span><br></pre></td></tr></table></figure>


<h3 id="性能验证测试"><a href="#性能验证测试" class="headerlink" title="性能验证测试"></a>性能验证测试</h3><p>参考: <a href="https://stackoverflow.com/questions/33480999/how-can-the-rep-stosb-instruction-execute-faster-than-the-equivalent-loop" target="_blank" rel="noopener">https://stackoverflow.com/questions/33480999/how-can-the-rep-stosb-instruction-execute-faster-than-the-equivalent-loop</a> 和 <a href="https://stackoverflow.com/questions/43343231/enhanced-rep-movsb-for-memcpy" target="_blank" rel="noopener">https://stackoverflow.com/questions/43343231/enhanced-rep-movsb-for-memcpy</a><br>中给出的测试, <code>REP STOSB</code>对于大块的数据是最优的选择. </p>
<p>在支持<code>ERMS</code>的<code>CPU</code>上,会对<code>REP STOSB</code>指令进行优化,使得其执行效率优于循环执行<code>mov</code>的逻辑.而在不支持<code>ERMS</code>的<code>CPU</code>上则只能选择循环<code>mov</code>的操作了. 这里如果<code>CPU</code>支持<code>AVX</code>, 则<code>mov</code>会变为<code>vmovdqa/vmovdqa64</code>等<code>AVX</code>的<code>mov</code>指令.</p>
<p>以下进一步在当前CPU上进行代码对比测试:</p>
<p>测试代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">char</span> str[<span class="number">5000</span>];</span><br><span class="line">   <span class="keyword">int</span> i =<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> <span class="built_in">max</span> = <span class="number">1</span>&lt;&lt;<span class="number">30</span>;</span><br><span class="line">   <span class="keyword">while</span>(i&lt;<span class="built_in">max</span>)&#123;</span><br><span class="line">    <span class="built_in">memset</span>(str, <span class="string">'a'</span>, <span class="number">3000</span>);</span><br><span class="line">        i++;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用一个第三方的优化过的<code>libc</code>库, 其中使用了<code>avx512</code>实现了<code>memset</code></p>
<p>下载地址: <a href="https://www.agner.org/optimize/asmlib.zip" target="_blank" rel="noopener">https://www.agner.org/optimize/asmlib.zip</a></p>
<p>参考连接: <a href="https://www.agner.org/optimize/#asmlib" target="_blank" rel="noopener">https://www.agner.org/optimize/#asmlib</a></p>
<p>分别进行编译后运行<code>perf</code>测试性能: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">new_acu:pilot@quanta2:~/wuding$ gcc 1.c -o asmlib ./libaelf64o.a</span><br><span class="line">new_acu:pilot@quanta2:~/wuding$ gcc 1.c -o origin</span><br><span class="line"></span><br><span class="line">new_acu:pilot@quanta2:~/wuding$ perf stat ./asmlib</span><br><span class="line"></span><br><span class="line"> Performance counter stats for './asmlib':</span><br><span class="line"></span><br><span class="line">      33809.757694      task-clock (msec)         #    1.000 CPUs utilized</span><br><span class="line">                11      context-switches          #    0.000 K/sec</span><br><span class="line">                 0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                50      page-faults               #    0.001 K/sec</span><br><span class="line">   108,191,627,848      cycles                    #    3.200 GHz</span><br><span class="line">   181,495,657,395      instructions              #    1.68  insn per cycle</span><br><span class="line">    56,914,104,466      branches                  # 1683.363 M/sec</span><br><span class="line">           153,916      branch-misses             #    0.00% of all branches</span><br><span class="line"></span><br><span class="line">      33.810266264 seconds time elapsed</span><br><span class="line"></span><br><span class="line">      33.809945000 seconds user</span><br><span class="line">       0.000000000 seconds sys</span><br><span class="line"></span><br><span class="line">new_acu:pilot@quanta2:~/wuding$ perf stat ./origin</span><br><span class="line"></span><br><span class="line"> Performance counter stats for './origin':</span><br><span class="line"></span><br><span class="line">      34796.854964      task-clock (msec)         #    1.000 CPUs utilized</span><br><span class="line">                15      context-switches          #    0.000 K/sec</span><br><span class="line">                 1      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                50      page-faults               #    0.001 K/sec</span><br><span class="line">   111,350,368,185      cycles                    #    3.200 GHz</span><br><span class="line">    29,025,326,422      instructions              #    0.26  insn per cycle</span><br><span class="line">     7,522,153,422      branches                  #  216.173 M/sec</span><br><span class="line">           168,441      branch-misses             #    0.00% of all branches</span><br><span class="line"></span><br><span class="line">      34.805927226 seconds time elapsed</span><br><span class="line"></span><br><span class="line">      34.797053000 seconds user</span><br><span class="line">       0.000000000 seconds sys</span><br></pre></td></tr></table></figure>


<p>对比可以发现运行性能仅提升约2%.</p>
<p>查看使用<code>asmlib</code>运行时的<code>perf top</code>可见热点代码, 可验证的确使用的是<code>avx512</code>相关指令: <code>vmovdqu64</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">      │</span><br><span class="line">      │    00000000000008ee &lt;L050&gt;:</span><br><span class="line">      │    L050():</span><br><span class="line">95.91 │      vmovdqu64 %zmm16,(%rdi)</span><br><span class="line"> 0.01 │      add    $0x40,%rdi</span><br><span class="line">      │      and    $0xffffffffffffffc0,%rdi</span><br><span class="line">      │      lea    (%rcx,%rdx,1),%rax</span><br><span class="line"> 4.08 │      and    $0xffffffffffffffc0,%rax</span><br><span class="line">      │      sub    %rax,%rdi</span><br><span class="line">      │      cmp    MemsetCacheLimit,%rdx</span><br><span class="line">      │    → ja     L200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      │   Disassembly of section .text:</span><br><span class="line">      │</span><br><span class="line">      │   0000000000000910 &lt;L100&gt;:</span><br><span class="line">      │   L100():</span><br><span class="line">55.17 │0:   vmovdqa64 %zmm16,(%rax,%rdi,1)</span><br><span class="line">      │     add    $0x40,%rdi</span><br><span class="line">44.83 │   ↑ jne    0</span><br></pre></td></tr></table></figure>

<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>综合分析来看, <code>glibc</code>的<code>memset</code>已经进行了优化. <code>rep stos</code>指令的性能并不差. </p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/linux/" rel="tag"># linux</a>
              <a href="/tags/C/" rel="tag"># C</a>
          </div>

        
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<link rel="stylesheet" href="/css/highlight/styles/github.css">

<!--
 <script src="https://utteranc.es/client.js"
        repo="woodpenker/woodpenker.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script> 
-->


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/05/11/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86mmap%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98%E9%BB%98%E8%AE%A4%E5%AF%B9%E9%BD%90/" rel="prev" title="Linux内存管理mmap分配内存默认对齐">
      <i class="fa fa-chevron-left"></i> Linux内存管理mmap分配内存默认对齐
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/12/05/%E8%BF%91%E6%9C%9F%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%84%9F%E6%82%9F/" rel="next" title="近期的学习感悟">
      近期的学习感悟 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Glibc的memset源码分析"><span class="nav-number">1.</span> <span class="nav-text">Glibc的memset源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境说明"><span class="nav-number">1.0.1.</span> <span class="nav-text">环境说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码分析"><span class="nav-number">1.0.2.</span> <span class="nav-text">代码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#glibc代码逻辑验证"><span class="nav-number">1.0.3.</span> <span class="nav-text">glibc代码逻辑验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#avx指令可能导致cpu降频的问题"><span class="nav-number">1.0.3.1.</span> <span class="nav-text">avx指令可能导致cpu降频的问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#性能验证测试"><span class="nav-number">1.0.4.</span> <span class="nav-text">性能验证测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结论"><span class="nav-number">1.0.5.</span> <span class="nav-text">结论</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">woodpenker</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">woodpenker</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">247k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">3:44</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'TQssKihDiGGbSY1kYhITVjH6-gzGzoHsz',
      appKey     : 'nR7QfbpY2Pp701SrxCfINdpm',
      placeholder: "Go go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
